# cl-hive Production Node - Docker Compose
#
# Usage:
#   1. Run ./setup.sh for interactive configuration, OR
#   2. Copy .env.example to .env and configure manually
#   3. docker-compose up -d
#   4. docker-compose logs -f
#
# Production deployment:
#   ./setup.sh                     # Interactive wizard
#   docker-compose up -d           # Start with production settings
#
# Access lightning-cli:
#   docker-compose exec cln lightning-cli getinfo

version: '3.8'

services:
  cln:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: cl-hive-node:0.1.0-dev
    container_name: cl-hive-node
    restart: unless-stopped

    # Graceful shutdown configuration
    stop_grace_period: 120s
    stop_signal: SIGTERM

    # Resource limits (override via docker-compose.override.yml or .env)
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-4}'
          memory: ${MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${CPU_RESERVATION:-2}'
          memory: ${MEMORY_RESERVATION:-4G}

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Required capabilities for WireGuard and networking
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - NET_RAW
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0

    environment:
      # Bitcoin RPC (required)
      - BITCOIN_RPCHOST=${BITCOIN_RPCHOST:-host.docker.internal}
      - BITCOIN_RPCPORT=${BITCOIN_RPCPORT:-8332}
      - BITCOIN_RPCUSER=${BITCOIN_RPCUSER}
      - BITCOIN_RPCPASSWORD=${BITCOIN_RPCPASSWORD}

      # Network
      - NETWORK=${NETWORK:-bitcoin}

      # Node Identity
      - ALIAS=${ALIAS:-cl-hive-node}
      - RGB=${RGB:-e33502}

      # Network Mode & Connectivity
      - LIGHTNING_PORT=${LIGHTNING_PORT:-9736}
      - NETWORK_MODE=${NETWORK_MODE:-tor}
      - ANNOUNCE_ADDR=${ANNOUNCE_ADDR:-}

      # WireGuard VPN (credentials from VPN admin)
      - WIREGUARD_ENABLED=${WIREGUARD_ENABLED:-false}
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY:-}
      - WG_ADDRESS=${WG_ADDRESS:-}
      - WG_PEER_PUBLIC_KEY=${WG_PEER_PUBLIC_KEY:-}
      - WG_PEER_ENDPOINT=${WG_PEER_ENDPOINT:-}
      - WG_DNS=${WG_DNS:-}
      - WG_PEER_KEEPALIVE=${WG_PEER_KEEPALIVE:-25}

      # cl-hive
      - HIVE_GOVERNANCE_MODE=${HIVE_GOVERNANCE_MODE:-advisor}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Lightning directory (used by supervisord)
      - LIGHTNING_DIR=/data/lightning/${NETWORK:-bitcoin}

    volumes:
      # Persistent data
      - lightning-data:/data/lightning

      # WireGuard config (optional)
      - ${WIREGUARD_CONFIG_PATH:-./wireguard}:/etc/wireguard:ro

      # Custom configs (optional)
      - ${CUSTOM_CONFIG_PATH:-./config}:/etc/lightning/custom:ro

    ports:
      # Lightning P2P (only needed for clearnet/hybrid modes)
      - "${LIGHTNING_PORT:-9736}:${LIGHTNING_PORT:-9736}"

      # REST API (optional, uncomment if needed)
      # - "8080:8080"

      # WireGuard (only if enabled)
      - "${WIREGUARD_PORT:-51820}:51820/udp"

    networks:
      - lightning-network

    healthcheck:
      test: ["CMD", "lightning-cli", "--lightning-dir=/data/lightning/${NETWORK:-bitcoin}", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,node"
        tag: "{{.Name}}/{{.ID}}"

    labels:
      - "com.cl-hive.service=lightning"
      - "com.cl-hive.backup=true"

volumes:
  lightning-data:
    driver: local
    labels:
      - "com.cl-hive.backup=critical"

networks:
  lightning-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
